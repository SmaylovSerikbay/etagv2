{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | My Business Card</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="widget-form-container">
        <div class="widget-form-header">
            <h1>{{ title }}</h1>
            <a href="{% url 'profiles:profile_detail' hash=profile.hash %}" class="back-btn" title="Назад">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" class="widget-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                {{ form.title }}
                {% if form.title.errors %}
                    <div class="error">{{ form.title.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.content.id_for_label }}">{{ form.content.label }}</label>
                {{ form.content }}
                {% if form.content.errors %}
                    <div class="error">{{ form.content.errors.0 }}</div>
                {% endif %}
                <div class="help-text" id="content-help">Введите содержимое</div>
            </div>

            <div class="form-group">
                <label for="id_color">Цвет кнопки</label>
                <input type="hidden" id="id_color_hidden" name="color" value="{{ form.initial.color|default:'#111111' }}">
                <div class="color-picker" id="colorPicker">
                    <button type="button" class="color-option" data-color="#10B981" style="--swatch:#10B981" aria-label="Зелёный"></button>
                    <button type="button" class="color-option" data-color="#F97316" style="--swatch:#F97316" aria-label="Оранжевый"></button>
                    <button type="button" class="color-option" data-color="#D97706" style="--swatch:#D97706" aria-label="Янтарный"></button>
                    <button type="button" class="color-option" data-color="#FACC15" style="--swatch:#FACC15" aria-label="Жёлтый"></button>
                    <button type="button" class="color-option" data-color="#22C55E" style="--swatch:#22C55E" aria-label="Лаймовый"></button>
                    <button type="button" class="color-option" data-color="#2DD4BF" style="--swatch:#2DD4BF" aria-label="Бирюзовый"></button>
                    <button type="button" class="color-option" data-color="#3B82F6" style="--swatch:#3B82F6" aria-label="Синий"></button>
                    <button type="button" class="color-option" data-color="#8B5CF6" style="--swatch:#8B5CF6" aria-label="Фиолетовый"></button>
                    <button type="button" class="color-option" data-color="#EC4899" style="--swatch:#EC4899" aria-label="Розовый"></button>
                    <button type="button" class="color-option" data-color="#111111" style="--swatch:#111111" aria-label="Чёрный"></button>
                    <label class="color-option custom" aria-label="Другой цвет">
                        <input type="color" id="customColorInput" value="{{ form.initial.color|default:'#111111' }}" aria-label="Выбрать цвет">
                    </label>
                </div>
                <div class="help-text">Выберите один из цветов или задайте свой</div>
            </div>

            <div class="form-group" style="display: none;">
                <label for="{{ form.widget_type.id_for_label }}">{{ form.widget_type.label }}</label>
                {{ form.widget_type }}
            </div>
            {{ form.icon.as_hidden }}
            {{ form.is_active.as_hidden }}
            {{ form.order.as_hidden }}

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" style="background:#000;border-color:#000;">
                    <i class="fas fa-plus"></i>
                    Добавить
                </button>
                <a href="{% url 'profiles:profile_detail' hash=profile.hash %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Отмена
                </a>
            </div>
        </form>

        <!-- Предварительный просмотр -->
        <div class="widget-preview-section">
            <h3>Предварительный просмотр</h3>
            <div id="preview-button" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;color:#ffffff;font-weight:600;background:#111111;">
                <i id="preview-icon" class="fas fa-cog" style="font-size:20px;color:#ffffff;"></i>
                <span id="preview-title">Ваша кнопка</span>
            </div>
            <div id="preview-hint" style="margin-top:8px;color:var(--gray-600);font-size:0.9rem;">Введите содержимое</div>
        </div>
    </div>

    <script>
        function updatePreview() {
            const title = document.getElementById('id_title').value || 'Ваша кнопка';
            const content = document.getElementById('id_content').value || 'Введите содержимое';
            const icon = document.getElementById('id_icon') ? document.getElementById('id_icon').value : 'fas fa-cog';
            const color = document.getElementById('id_color_hidden').value || '#111111';

            const previewBtn = document.getElementById('preview-button');
            const previewTitle = document.getElementById('preview-title');
            const previewIcon = document.getElementById('preview-icon');
            const previewHint = document.getElementById('preview-hint');

            previewBtn.style.backgroundColor = color;
            previewIcon.className = icon || 'fas fa-phone';
            previewIcon.style.color = '#ffffff';
            previewTitle.style.color = '#ffffff';
            previewTitle.textContent = title;
            previewHint.textContent = content;
        }

        // Добавляем обработчики событий
        function updateContentHelp() {
            const widgetType = document.getElementById('id_widget_type').value;
            const helpText = document.getElementById('content-help');
            const contentField = document.getElementById('id_content');
            
            const helpTexts = {
                'button': 'Введите содержимое (URL, текст, номер телефона, email)',
                'link': 'Введите ссылку или текст',
                'contact': 'Введите телефон, email или адрес',
                'social': 'Введите username, ссылку или номер телефона',
                'text': 'Введите текст для отображения'
            };
            
            const placeholders = {
                'button': 'Введите содержимое',
                'link': 'https://example.com',
                'contact': '+7 (999) 123-45-67',
                'social': '@username или ссылка',
                'text': 'Ваш текст'
            };
            
            helpText.textContent = helpTexts[widgetType] || 'Введите содержимое';
            contentField.placeholder = placeholders[widgetType] || 'Введите содержимое';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['id_title', 'id_content', 'id_icon'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            // Обновляем подсказки при смене типа виджета
            const widgetTypeField = document.getElementById('id_widget_type');
            if (widgetTypeField) {
                widgetTypeField.addEventListener('change', updateContentHelp);
                updateContentHelp();
            }
            
            // Цветоподбор как на шаблоне
            const hiddenColor = document.getElementById('id_color_hidden');
            const picker = document.getElementById('colorPicker');
            picker.addEventListener('click', function(e){
                const btn = e.target.closest('.color-option:not(.custom)');
                if (!btn) return;
                const color = btn.getAttribute('data-color');
                hiddenColor.value = color;
                picker.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                updatePreview();
            });
            const customInput = document.getElementById('customColorInput');
            if (customInput) {
                customInput.addEventListener('input', function(){
                    hiddenColor.value = this.value;
                    picker.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                    customInput.parentElement.classList.add('active');
                    updatePreview();
                });
            }
            const initial = hiddenColor.value || '#111111';
            const initialBtn = picker.querySelector(`.color-option[data-color="${initial}"]`);
            if (initialBtn) initialBtn.classList.add('active'); else customInput && customInput.parentElement.classList.add('active');
            updatePreview();
        });
    </script>
</body>
</html>
