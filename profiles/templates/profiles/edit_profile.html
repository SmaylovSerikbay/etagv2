{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование профиля | My Business Card</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="edit-profile-container">
        <div class="edit-header">
            <a href="{% url 'profiles:profile_detail' hash=user.profile.hash %}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Редактирование профиля</h1>
        </div>

        <div class="edit-content">
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="edit-form" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="alert alert-error" role="alert">
                    {{ form.non_field_errors|join:" | " }}
                </div>
                {% endif %}
                
                <!-- Основная информация -->
                <div class="form-section">
                    <h2 class="section-title">Основная информация</h2>
                    
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error">{{ form.name.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.info.id_for_label }}">{{ form.info.label }}</label>
                        {{ form.info }}
                        {% if form.info.errors %}
                        <div class="error">{{ form.info.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.avatar.id_for_label }}">{{ form.avatar.label }}</label>
                            <div class="image-input">
                                <div class="image-row">
                                    <div class="image-thumb" id="avatar-thumb">
                                        {% if user.profile.avatar %}
                                            <img id="avatar-preview" src="{{ user.profile.avatar.url }}" alt="Avatar" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;cursor:pointer;">
                                        {% else %}
                                            <div class="avatar-placeholder" style="width:72px;height:72px;border-radius:12px;border:1px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;color:#94a3b8;">—</div>
                                        {% endif %}
                                    </div>
                                    <div class="image-meta">
                                        <div class="file-name" id="avatar-file-name" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block;">
                                            {% if user.profile.avatar %}{{ user.profile.avatar.name }}{% else %}Файл не выбран{% endif %}
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="btn btn-outline" onclick="document.querySelector('input[type=file][name=avatar]').click()">Изменить</button>
                                            {% if user.profile.avatar %}
                                            <button type="button" class="btn btn-danger" onclick="toggleClear('avatar')">Очистить</button>
                                            {% endif %}
                                        </div>
                                        <small class="help-text">{{ form.avatar.help_text }}</small>
                                    </div>
                </div>
                                <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;padding:0;margin:-1px;">
                                    {{ form.avatar }}
                                </div>
                            </div>
                        </div>
                        {% if form.company.errors %}
                        <div class="error">{{ form.company.errors|join:", " }}</div>
                        {% endif %}

                        <div class="form-group">
                            <label for="{{ form.background.id_for_label }}">{{ form.background.label }}</label>
                            <div class="image-input">
                                <div class="image-row">
                                    <div class="image-thumb" id="background-thumb">
                                        {% if user.profile.background %}
                                            <img id="background-preview" src="{{ user.profile.background.url }}" alt="Background" style="width:132px;height:50px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;">
                                        {% else %}
                                            <div class="background-placeholder" style="width:132px;height:50px;border-radius:8px;border:1px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;color:#94a3b8;">—</div>
                                        {% endif %}
                                    </div>
                                    <div class="image-meta">
                                        <div class="file-name" id="background-file-name" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block;">
                                            {% if user.profile.background %}{{ user.profile.background.name }}{% else %}Файл не выбран{% endif %}
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="btn btn-outline" onclick="document.querySelector('input[type=file][name=background]').click()">Изменить</button>
                                            {% if user.profile.background %}
                                            <button type="button" class="btn btn-danger" onclick="toggleClear('background')">Очистить</button>
                                            {% endif %}
                                        </div>
                                        <small class="help-text">{{ form.background.help_text }}</small>
                                    </div>
                </div>
                                <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;padding:0;margin:-1px;">
                                    {{ form.background }}
                                </div>
                            </div>
                        </div>
                        {% if form.position.errors %}
                        <div class="error">{{ form.position.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Работа -->
                <div class="form-section">
                    <h2 class="section-title">Работа</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.company.id_for_label }}">{{ form.company.label }}</label>
                            {{ form.company }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.position.id_for_label }}">{{ form.position.label }}</label>
                            {{ form.position }}
                        </div>
                    </div>
                </div>

                <!-- Контакты скрыты: управляются только через виджеты -->
                <div class="form-section">
                    <h2 class="section-title">Контакты</h2>
                    <p class="subtitle">Контакты теперь редактируются только через раздел виджетов.</p>
                    <a href="{% url 'profiles:widget_templates' %}" class="btn btn-outline">
                        <i class="fas fa-external-link-alt"></i>
                        Открыть управление виджетами
                    </a>
                </div>

                <div class="form-actions">
                    <button type="submit" class="save-button">
                        <i class="fas fa-save"></i>
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>

<div id="imagePreviewModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:1200;align-items:center;justify-content:center;">
    <div style="background:#111;border-radius:12px;max-width:90vw;max-height:90vh;padding:8px;display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;justify-content:flex-end;">
            <button type="button" id="imagePreviewClose" class="btn btn-outline" style="padding:6px 10px;">Закрыть</button>
        </div>
        <img id="imagePreviewLarge" src="" alt="preview" style="max-width:86vw;max-height:80vh;object-fit:contain;border-radius:8px;background:#000;">
    </div>
    </div>

<script>
        const MAX_AVATAR_MB = 5;  // Лимит 5MB
    const MAX_BACKGROUND_MB = 5;  // Лимит 5MB
    function formatMB(bytes){ return (bytes/1024/1024).toFixed(2); }

    // Сверхбыстрая функция сжатия изображения
    function compressImage(file, maxSizeMB = 5, quality = 0.5) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Очень агрессивно уменьшаем размер для мгновенной обработки
                let { width, height } = img;
                const maxDimension = 600; // Еще больше уменьшаем для скорости
                
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    } else {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Рисуем сжатое изображение
                ctx.drawImage(img, 0, 0, width, height);
                
                // Мгновенное сжатие с очень низким качеством
                const qualityLevels = [0.5, 0.3, 0.2]; // Только 3 попытки
                let currentIndex = 0;
                
                const tryCompress = () => {
                    if (currentIndex >= qualityLevels.length) {
                        resolve(canvas.toBlob((blob) => blob, 'image/jpeg', 0.1));
                        return;
                    }
                    
                    canvas.toBlob((blob) => {
                        const sizeMB = blob.size / (1024 * 1024);
                        if (sizeMB <= maxSizeMB) {
                            resolve(blob);
                        } else {
                            currentIndex++;
                            tryCompress();
                        }
                    }, 'image/jpeg', qualityLevels[currentIndex]);
                };
                
                tryCompress();
            };
            
            img.src = URL.createObjectURL(file);
        });
    }

    function toggleClear(field) {
        const clearCheckbox = document.querySelector(`input[type=checkbox][name=${field}-clear]`);
        if (clearCheckbox) {
            clearCheckbox.checked = true;
            // UI feedback
            const nameEl = document.getElementById(`${field}-file-name`);
            if (nameEl) nameEl.textContent = 'Будет очищено при сохранении';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Click-to-preview
        const modal = document.getElementById('imagePreviewModal');
        const modalImg = document.getElementById('imagePreviewLarge');
        const modalClose = document.getElementById('imagePreviewClose');
        function openPreview(src){ if(!src) return; modalImg.src = src; modal.style.display = 'flex'; document.body.style.overflow='hidden'; }
        function closePreview(){ modal.style.display = 'none'; modalImg.src=''; document.body.style.overflow=''; }
        if (modalClose) modalClose.addEventListener('click', closePreview);
        if (modal) modal.addEventListener('click', function(e){ if(e.target === modal){ closePreview(); } });
        const avatarPrev = document.getElementById('avatar-preview');
        if (avatarPrev) avatarPrev.addEventListener('click', function(){ openPreview(this.src); });
        const bgPrev = document.getElementById('background-preview');
        if (bgPrev) bgPrev.addEventListener('click', function(){ openPreview(this.src); });

        const avatarInput = document.querySelector('input[type=file][name=avatar]');
        const avatarName = document.getElementById('avatar-file-name');
        if (avatarInput && avatarName) {
            avatarInput.addEventListener('change', async function() {
                const file = this.files && this.files[0];
                if (file) {
                    // Показываем индикатор загрузки
                    avatarName.textContent = 'Обработка изображения...';
                    
                    try {
                        // Файлы больше 5MB не сжимаем на клиенте — сжатие выполнит сервер
                        if (file.size > MAX_AVATAR_MB * 1024 * 1024) {
                            avatarName.textContent = 'Файл выбран (>5MB). Будет сжат при сохранении.';
                        }

                        // Для небольших файлов просто готовим превью (без автосабмита)
                        let processedFile = file;
                        
                        // Создаем новый File объект с сжатыми данными
                        const compressedFile = new File([processedFile], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        // Заменяем файл в input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        this.files = dataTransfer.files;
                        
                        avatarName.textContent = `${file.name} (${formatMB(processedFile.size)} МБ)`;
                        
                        const reader = new FileReader();
                        reader.onload = function(e){
                            const img = document.getElementById('avatar-preview');
                            const holder = document.getElementById('avatar-thumb');
                            if (img) {
                                img.src = e.target.result;
                            } else if (holder) {
                                holder.innerHTML = `<img id=\"avatar-preview\" src=\"${e.target.result}\" alt=\"Avatar\" style=\"width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;cursor:pointer;\">`;
                                const created = document.getElementById('avatar-preview');
                                if (created) created.addEventListener('click', function(){ openPreview(this.src); });
                            }
                            
                            // Ничего не отправляем автоматически — пользователь сам нажимает «Сохранить изменения»
                        };
                        reader.readAsDataURL(processedFile);
                    } catch (error) {
                        console.error('Ошибка сжатия изображения:', error);
                        alert('Ошибка при обработке изображения');
                        this.value = '';
                        avatarName.textContent = 'Файл не выбран';
                    }
                } else {
                    avatarName.textContent = 'Файл не выбран';
                }
                const clearCheckbox = document.querySelector('input[type=checkbox][name=avatar-clear]');
                if (clearCheckbox) clearCheckbox.checked = false;
            });
        }

        const bgInput = document.querySelector('input[type=file][name=background]');
        const bgName = document.getElementById('background-file-name');
        if (bgInput && bgName) {
            bgInput.addEventListener('change', async function() {
                const file = this.files && this.files[0];
                if (file) {
                    // Показываем индикатор загрузки
                    bgName.textContent = 'Обработка изображения...';
                    
                    try {
                        // Файлы больше 5MB не сжимаем на клиенте — сжатие выполнит сервер
                        if (file.size > MAX_BACKGROUND_MB * 1024 * 1024) {
                            bgName.textContent = 'Файл выбран (>5MB). Будет сжат при сохранении.';
                        }

                        // Для небольших файлов просто готовим превью (без автосабмита)
                        let processedFile = file;
                        
                        // Создаем новый File объект с сжатыми данными
                        const compressedFile = new File([processedFile], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        // Заменяем файл в input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        this.files = dataTransfer.files;
                        
                        bgName.textContent = `${file.name} (${formatMB(processedFile.size)} МБ)`;
                        
                        const reader = new FileReader();
                        reader.onload = function(e){
                            const img = document.getElementById('background-preview');
                            const holder = document.getElementById('background-thumb');
                            if (img) {
                                img.src = e.target.result;
                            } else if (holder) {
                                holder.innerHTML = `<img id=\"background-preview\" src=\"${e.target.result}\" alt=\"Background\" style=\"width:132px;height:50px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;\">`;
                                const created = document.getElementById('background-preview');
                                if (created) created.addEventListener('click', function(){ openPreview(this.src); });
                            }
                            
                            // Ничего не отправляем автоматически — пользователь сам нажимает «Сохранить изменения»
                        };
                        reader.readAsDataURL(processedFile);
                    } catch (error) {
                        console.error('Ошибка сжатия изображения:', error);
                        alert('Ошибка при обработке изображения');
                        this.value = '';
                        bgName.textContent = 'Файл не выбран';
                    }
                } else {
                    bgName.textContent = 'Файл не выбран';
                }
                const clearCheckbox = document.querySelector('input[type=checkbox][name=background-clear]');
                if (clearCheckbox) clearCheckbox.checked = false;
            });
        }
    });
</script>
</html> 