{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование профиля | My Business Card</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="edit-profile-container">
        <div class="edit-header">
            <a href="{% url 'profiles:profile_detail' hash=user.profile.hash %}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Редактирование профиля</h1>
        </div>

        <div class="edit-content">
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="edit-form" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="alert alert-error" role="alert">
                    {{ form.non_field_errors|join:" | " }}
                </div>
                {% endif %}
                
                <!-- Основная информация -->
                <div class="form-section">
                    <h2 class="section-title">Основная информация</h2>
                    
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error">{{ form.name.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.info.id_for_label }}">{{ form.info.label }}</label>
                        {{ form.info }}
                        {% if form.info.errors %}
                        <div class="error">{{ form.info.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.avatar.id_for_label }}">{{ form.avatar.label }}</label>
                            <div class="image-input">
                                <div class="image-row">
                                    <div class="image-thumb">
                                        {% if user.profile.avatar %}
                                            <img src="{{ user.profile.avatar.url }}" alt="Avatar" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;">
                                        {% else %}
                                            <div style="width:72px;height:72px;border-radius:12px;border:1px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;color:#94a3b8;">—</div>
                                        {% endif %}
                                    </div>
                                    <div class="image-meta">
                                        <div class="file-name" id="avatar-file-name">
                                            {% if user.profile.avatar %}{{ user.profile.avatar.name }}{% else %}Файл не выбран{% endif %}
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="btn btn-outline" onclick="document.querySelector('input[type=file][name=avatar]').click()">Изменить</button>
                                            {% if user.profile.avatar %}
                                            <button type="button" class="btn btn-danger" onclick="toggleClear('avatar')">Очистить</button>
                                            {% endif %}
                                        </div>
                                        <small class="help-text">Рекомендуемый размер 100x100</small>
                                    </div>
                                </div>
                                <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;padding:0;margin:-1px;">
                                    {{ form.avatar }}
                                </div>
                            </div>
                        </div>
                        {% if form.company.errors %}
                        <div class="error">{{ form.company.errors|join:", " }}</div>
                        {% endif %}

                        <div class="form-group">
                            <label for="{{ form.background.id_for_label }}">{{ form.background.label }}</label>
                            <div class="image-input">
                                <div class="image-row">
                                    <div class="image-thumb">
                                        {% if user.profile.background %}
                                            <img src="{{ user.profile.background.url }}" alt="Background" style="width:132px;height:50px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;">
                                        {% else %}
                                            <div style="width:132px;height:50px;border-radius:8px;border:1px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;color:#94a3b8;">—</div>
                                        {% endif %}
                                    </div>
                                    <div class="image-meta">
                                        <div class="file-name" id="background-file-name">
                                            {% if user.profile.background %}{{ user.profile.background.name }}{% else %}Файл не выбран{% endif %}
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="btn btn-outline" onclick="document.querySelector('input[type=file][name=background]').click()">Изменить</button>
                                            {% if user.profile.background %}
                                            <button type="button" class="btn btn-danger" onclick="toggleClear('background')">Очистить</button>
                                            {% endif %}
                                        </div>
                                        <small class="help-text">Рекомендуемый размер 530x200</small>
                                    </div>
                                </div>
                                <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;padding:0;margin:-1px;">
                                    {{ form.background }}
                                </div>
                            </div>
                        </div>
                        {% if form.position.errors %}
                        <div class="error">{{ form.position.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Работа -->
                <div class="form-section">
                    <h2 class="section-title">Работа</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.company.id_for_label }}">{{ form.company.label }}</label>
                            {{ form.company }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.position.id_for_label }}">{{ form.position.label }}</label>
                            {{ form.position }}
                        </div>
                    </div>
                </div>

                <!-- Контакты скрыты: управляются только через виджеты -->
                <div class="form-section">
                    <h2 class="section-title">Контакты</h2>
                    <p class="subtitle">Контакты теперь редактируются только через раздел виджетов.</p>
                    <a href="{% url 'profiles:widget_templates' %}" class="btn btn-outline">
                        <i class="fas fa-external-link-alt"></i>
                        Открыть управление виджетами
                    </a>
                </div>

                <div class="form-actions">
                    <button type="submit" class="save-button">
                        <i class="fas fa-save"></i>
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
<script>
    function toggleClear(field) {
        const clearCheckbox = document.querySelector(`input[type=checkbox][name=${field}-clear]`);
        if (clearCheckbox) {
            clearCheckbox.checked = true;
            // UI feedback
            const nameEl = document.getElementById(`${field}-file-name`);
            if (nameEl) nameEl.textContent = 'Будет очищено при сохранении';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const avatarInput = document.querySelector('input[type=file][name=avatar]');
        const avatarName = document.getElementById('avatar-file-name');
        if (avatarInput && avatarName) {
            avatarInput.addEventListener('change', function() {
                avatarName.textContent = this.files && this.files[0] ? this.files[0].name : 'Файл не выбран';
                const clearCheckbox = document.querySelector('input[type=checkbox][name=avatar-clear]');
                if (clearCheckbox) clearCheckbox.checked = false;
            });
        }

        const bgInput = document.querySelector('input[type=file][name=background]');
        const bgName = document.getElementById('background-file-name');
        if (bgInput && bgName) {
            bgInput.addEventListener('change', function() {
                bgName.textContent = this.files && this.files[0] ? this.files[0].name : 'Файл не выбран';
                const clearCheckbox = document.querySelector('input[type=checkbox][name=background-clear]');
                if (clearCheckbox) clearCheckbox.checked = false;
            });
        }
    });
</script>
</html> 